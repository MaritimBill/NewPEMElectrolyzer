<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HE-NMPC PEM Electrolyzer Controller</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f9fafb;
            --gray: #9ca3af;
            --border: #374151;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header Styles */
        .header {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--success));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text .subtitle {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.disconnected { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(31, 41, 55, 0.6);
            border-radius: 8px;
            padding: 0.5rem;
            margin: 1rem 0;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Metric Cards */
        .metric-card {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .metric-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.875rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Chart Containers */
        .chart-container {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--light);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Mini Charts Grid */
        .mini-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mini-chart-container {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            height: 120px;
        }

        /* MPC Comparison Section */
        .mpc-comparison-section {
            margin-bottom: 2rem;
        }

        .mpc-comparison-section h3 {
            color: var(--light);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mpc-card {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .mpc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .mpc-card.he-nmpc {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--dark) 0%, #1e3a8a 100%);
        }

        .mpc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .mpc-header h4 {
            color: var(--light);
            margin: 0;
            font-size: 1.2rem;
        }

        .mpc-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .mpc-badge.best {
            background: var(--success);
            color: white;
        }

        .mpc-metrics .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .mpc-metrics .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .mpc-metrics .label {
            color: var(--gray);
        }

        .mpc-metrics .value {
            color: var(--light);
            font-weight: bold;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Control Panel */
        .control-panel {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .control-btn {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-btn.start { background: var(--success); color: white; }
        .control-btn.stop { background: var(--danger); color: white; }
        .control-btn.reset { background: var(--warning); color: white; }
        .control-btn.emergency { 
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            animation: pulse 2s infinite;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            max-width: 400px;
        }

        .notification {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.success { border-left: 4px solid var(--success); }
        .notification.warning { border-left: 4px solid var(--warning); }
        .notification.error { border-left: 4px solid var(--danger); }
        .notification.info { border-left: 4px solid var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .notification-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* System Metrics */
        .system-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-badge {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .metric-badge .label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .metric-badge .value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--light);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-badge.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-badge.info { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">H₂</div>
                    <div class="logo-text">
                        <h1>HE-NMPC Electrolyzer Controller</h1>
                        <div class="subtitle">Hybrid Evolutionary Neural Model Predictive Control</div>
                    </div>
                </div>
                <div class="system-status">
                    <div class="status-indicator">
                        <div class="status-dot" id="connectionStatus"></div>
                        <span id="connectionText">Connecting...</span>
                    </div>
                    <div id="systemStatus">System Initializing...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="analytics">MPC Analytics</button>
            <button class="nav-tab" data-tab="safety">Safety Monitor</button>
            <button class="nav-tab" data-tab="economic">Economic Analysis</button>
            <button class="nav-tab" data-tab="simulink">Simulink Integration</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Control Panel -->
            <div class="control-panel">
                <h3>System Controls</h3>
                <div class="control-grid">
                    <button class="control-btn start" data-action="start">Start System</button>
                    <button class="control-btn stop" data-action="stop">Stop System</button>
                    <button class="control-btn reset" data-action="reset">Reset</button>
                    <button class="control-btn emergency" data-action="emergency">Emergency Stop</button>
                </div>
            </div>

            <!-- System Metrics -->
            <div class="system-metrics">
                <div class="metric-badge">
                    <div class="label">Controller Mode</div>
                    <div class="status-badge success" id="controllerMode">HE-NMPC</div>
                </div>
                <div class="metric-badge">
                    <div class="label">Operation Mode</div>
                    <div class="status-badge info" id="operationMode">SIMULATION</div>
                </div>
                <div class="metric-badge">
                    <div class="label">Safety Violations</div>
                    <div class="status-badge success" id="safetyViolations">0</div>
                </div>
                <div class="metric-badge">
                    <div class="label">Simulink Status</div>
                    <div class="status-badge warning" id="simulinkStatus">Fallback</div>
                </div>
            </div>

            <!-- Mini Charts -->
            <div class="mini-charts-grid">
                <div class="mini-chart-container">
                    <canvas id="productionMiniChart"></canvas>
                </div>
                <div class="mini-chart-container">
                    <canvas id="efficiencyMiniChart"></canvas>
                </div>
                <div class="mini-chart-container">
                    <canvas id="safetyMiniChart"></canvas>
                </div>
                <div class="mini-chart-container">
                    <canvas id="temperatureMiniChart"></canvas>
                </div>
            </div>

            <!-- Main Charts -->
            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-title">Production Trends</div>
                    <div class="chart-wrapper">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">System Parameters</div>
                    <div class="chart-wrapper">
                        <canvas id="parametersChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Live Data Feed -->
            <div class="chart-container">
                <div class="chart-title">Live Data Feed</div>
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">O₂ Production Rate</div>
                        </div>
                        <div class="metric-value" id="liveO2Production">--</div>
                        <div class="metric-trend trend-up">+2.4% from target</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">System Efficiency</div>
                        </div>
                        <div class="metric-value" id="liveEfficiency">--</div>
                        <div class="metric-trend trend-up">Optimal range</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Stack Temperature</div>
                        </div>
                        <div class="metric-value" id="liveTemperature">--</div>
                        <div class="metric-trend trend-down">Within limits</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Power Consumption</div>
                        </div>
                        <div class="metric-value" id="livePower">--</div>
                        <div class="metric-trend trend-up">Stable</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics">
            <!-- Enhanced MPC Comparison Section -->
            <div class="mpc-comparison-section">
                <h3>Multi-MPC Controller Performance Comparison</h3>
                
                <div class="comparison-grid">
                    <!-- HE-NMPC -->
                    <div class="mpc-card he-nmpc">
                        <div class="mpc-header">
                            <h4>HE-NMPC</h4>
                            <span class="mpc-badge best">BEST</span>
                        </div>
                        <div class="mpc-metrics">
                            <div class="metric">
                                <span class="label">Efficiency:</span>
                                <span class="value" id="heNmpcEfficiency">84.5%</span>
                            </div>
                            <div class="metric">
                                <span class="label">Response Time:</span>
                                <span class="value" id="heNmpcResponse">0.8s</span>
                            </div>
                            <div class="metric">
                                <span class="label">Stability:</span>
                                <span class="value" id="heNmpcStability">98%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Traditional MPC -->
                    <div class="mpc-card traditional">
                        <div class="mpc-header">
                            <h4>Traditional MPC</h4>
                        </div>
                        <div class="mpc-metrics">
                            <div class="metric">
                                <span class="label">Efficiency:</span>
                                <span class="value" id="traditionalEfficiency">76.2%</span>
                            </div>
                            <div class="metric">
                                <span class="label">Response Time:</span>
                                <span class="value" id="traditionalResponse">1.5s</span>
                            </div>
                            <div class="metric">
                                <span class="label">Stability:</span>
                                <span class="value" id="traditionalStability">85%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stochastic MPC -->
                    <div class="mpc-card stochastic">
                        <div class="mpc-header">
                            <h4>Stochastic MPC</h4>
                        </div>
                        <div class="mpc-metrics">
                            <div class="metric">
                                <span class="label">Efficiency:</span>
                                <span class="value" id="stochasticEfficiency">79.8%</span>
                            </div>
                            <div class="metric">
                                <span class="label">Response Time:</span>
                                <span class="value" id="stochasticResponse">1.2s</span>
                            </div>
                            <div class="metric">
                                <span class="label">Stability:</span>
                                <span class="value" id="stochasticStability">92%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mixed Integer MPC -->
                    <div class="mpc-card mixed-integer">
                        <div class="mpc-header">
                            <h4>Mixed Integer MPC</h4>
                        </div>
                        <div class="mpc-metrics">
                            <div class="metric">
                                <span class="label">Efficiency:</span>
                                <span class="value" id="mixedIntegerEfficiency">81.3%</span>
                            </div>
                            <div class="metric">
                                <span class="label">Response Time:</span>
                                <span class="value" id="mixedIntegerResponse">2.1s</span>
                            </div>
                            <div class="metric">
                                <span class="label">Stability:</span>
                                <span class="value" id="mixedIntegerStability">88%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Comparison Charts -->
            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-title">Multi-MPC Performance Comparison</div>
                    <div class="chart-wrapper">
                        <canvas id="multiMpcComparisonChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">MPC Capability Radar</div>
                    <div class="chart-wrapper">
                        <canvas id="mpcPerformanceRadar"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-title">MPC Response Time Trends</div>
                    <div class="chart-wrapper">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Efficiency Trends Comparison</div>
                    <div class="chart-wrapper">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance Radar -->
            <div class="chart-container">
                <div class="chart-title">MPC Performance Radar Comparison</div>
                <div class="chart-wrapper">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Safety Tab -->
        <div class="tab-content" id="safety">
            <div class="chart-container">
                <div class="chart-title">Safety Margins Monitor</div>
                <div class="chart-wrapper">
                    <canvas id="safetyChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Temperature Margin</div>
                    </div>
                    <div class="metric-value" id="safetyValue">--</div>
                    <div class="metric-trend trend-up">Safe</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Pressure Margin</div>
                    </div>
                    <div class="metric-value">92.5%</div>
                    <div class="metric-trend trend-up">Optimal</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Voltage Stability</div>
                    </div>
                    <div class="metric-value">98.2%</div>
                    <div class="metric-trend trend-up">Excellent</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">System Integrity</div>
                    </div>
                    <div class="metric-value">99.8%</div>
                    <div class="metric-trend trend-up">Optimal</div>
                </div>
            </div>
        </div>

        <!-- Economic Tab -->
        <div class="tab-content" id="economic">
            <div class="chart-container">
                <div class="chart-title">Economic Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="economicChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Hourly Revenue</div>
                    </div>
                    <div class="metric-value">$245.80</div>
                    <div class="metric-trend trend-up">+12.5%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Operating Cost</div>
                    </div>
                    <div class="metric-value">$128.40</div>
                    <div class="metric-trend trend-down">-3.2%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Profit Margin</div>
                    </div>
                    <div class="metric-value">47.8%</div>
                    <div class="metric-trend trend-up">+8.1%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">ROI Projection</div>
                    </div>
                    <div class="metric-value">18.2 months</div>
                    <div class="metric-trend trend-down">Improved</div>
                </div>
            </div>
        </div>

        <!-- Simulink Tab -->
        <div class="tab-content" id="simulink">
            <div class="chart-container">
                <div class="chart-title">Simulink vs Real System Comparison</div>
                <div class="chart-wrapper">
                    <canvas id="simulinkChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Simulation Time</div>
                    </div>
                    <div class="metric-value" id="simTime">0s</div>
                    <div class="metric-trend">Running</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Data Points</div>
                    </div>
                    <div class="metric-value" id="dataPointsCount">0</div>
                    <div class="metric-trend trend-up">Receiving</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Data Rate</div>
                    </div>
                    <div class="metric-value" id="dataRate">0 Hz</div>
                    <div class="metric-trend">Stable</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Last Update</div>
                    </div>
                    <div class="metric-value" id="simulinkLastUpdate">--:--:--</div>
                    <div class="metric-trend">--</div>
                </div>
            </div>

            <!-- Simulink Live Data -->
            <div class="chart-container">
                <div class="chart-title">Simulink Live Parameters</div>
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">O₂ Production</div>
                        </div>
                        <div class="metric-value" id="simO2Production">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Stack Temperature</div>
                        </div>
                        <div class="metric-value" id="simStackTemp">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">System Efficiency</div>
                        </div>
                        <div class="metric-value" id="simEfficiency">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Power Consumption</div>
                        </div>
                        <div class="metric-value" id="simPower">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- JavaScript Files -->
    <script>
        // charts.js - Fixed Version
        class ChartManager {
            constructor() {
                this.charts = new Map();
                this.dataHistory = [];
                this.maxHistory = 100;
                this.initializationAttempts = 0;
                this.maxInitializationAttempts = 10;
                
                this.initWithRetry();
            }

            initWithRetry(retryCount = 0) {
                try {
                    this.initAllCharts();
                    console.log('Charts initialized successfully - waiting for real simulation data');
                } catch (error) {
                    console.warn('Chart initialization failed, retrying...', error);
                    if (retryCount < 3) {
                        setTimeout(() => this.initWithRetry(retryCount + 1), 500);
                    } else {
                        console.error('Failed to initialize charts after retries:', error);
                    }
                }
            }

            initAllCharts() {
                this.destroyAllCharts();
                
                if (!this.areEssentialCanvasesReady()) {
                    this.initializationAttempts++;
                    
                    if (this.initializationAttempts < this.maxInitializationAttempts) {
                        console.log(`Canvas initialization attempt ${this.initializationAttempts}/${this.maxInitializationAttempts}`);
                        setTimeout(() => this.initAllCharts(), 200);
                        return;
                    } else {
                        console.warn('Max initialization attempts reached, initializing available charts');
                    }
                }
                
                this.initializationAttempts = 0;
                this.initAvailableCharts();
            }

            destroyAllCharts() {
                this.charts.forEach((chart, chartId) => {
                    if (chart && typeof chart.destroy === 'function') {
                        try {
                            chart.destroy();
                        } catch (error) {
                            console.warn(`Error destroying chart ${chartId}:`, error);
                        }
                    }
                });
                this.charts.clear();
            }

            areEssentialCanvasesReady() {
                const essentialCanvases = [
                    'productionMiniChart', 'efficiencyMiniChart', 
                    'safetyMiniChart', 'temperatureMiniChart',
                    'productionChart', 'parametersChart'
                ];
                
                const ready = essentialCanvases.every(id => {
                    const canvas = document.getElementById(id);
                    return canvas !== null;
                });
                
                return ready;
            }

            initAvailableCharts() {
                console.log('Initializing available charts...');
                
                this.initMiniCharts();
                this.initMainCharts();
                this.initComparisonCharts();
                
                console.log('Available charts initialized:', this.charts.size);
            }

            initMiniCharts() {
                const miniChartConfigs = [
                    { id: 'productionMiniChart', color: '#3b82f6', label: 'Production' },
                    { id: 'efficiencyMiniChart', color: '#10b981', label: 'Efficiency' },
                    { id: 'safetyMiniChart', color: '#f59e0b', label: 'Safety' },
                    { id: 'temperatureMiniChart', color: '#ef4444', label: 'Temperature' }
                ];

                miniChartConfigs.forEach(config => {
                    const chart = this.createMiniChart(config.id, config.color, config.label);
                    if (chart) {
                        this.charts.set(config.id, chart);
                    }
                });
            }

            createMiniChart(canvasId, color, label) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error(`Canvas not found: ${canvasId}`);
                    return null;
                }

                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }

                const ctx = canvas.getContext('2d');
                const emptyData = Array(10).fill(null);

                try {
                    return new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(10).fill(''),
                            datasets: [{
                                label: label,
                                data: emptyData,
                                borderColor: color,
                                backgroundColor: this.hexToRgba(color, 0.2),
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                borderCapStyle: 'round'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            },
                            scales: {
                                x: { 
                                    display: false,
                                    grid: { display: false }
                                },
                                y: { 
                                    display: false,
                                    grid: { display: false },
                                    beginAtZero: true
                                }
                            },
                            interaction: { intersect: false }
                        }
                    });
                } catch (error) {
                    console.error(`Error creating chart ${canvasId}:`, error);
                    return null;
                }
            }

            initMainCharts() {
                this.createProductionChart();
                this.createParametersChart();
            }

            createProductionChart() {
                const canvas = document.getElementById('productionChart');
                if (!canvas) {
                    console.error('Production chart canvas not found');
                    return;
                }

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                try {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.generateTimeLabels(12),
                            datasets: [
                                {
                                    label: 'O₂ Production Rate',
                                    data: [],
                                    borderColor: '#3b82f6',
                                    backgroundColor: this.hexToRgba('#3b82f6', 0.1),
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'H₂ Production Rate',
                                    data: [],
                                    borderColor: '#10b981',
                                    backgroundColor: this.hexToRgba('#10b981', 0.1),
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#e5e7eb',
                                        font: { size: 12 }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Production Trends - Awaiting Simulation Data',
                                    color: '#f9fafb',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' }
                                },
                                y: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' },
                                    title: {
                                        display: true,
                                        text: 'Production Rate (L/min)',
                                        color: '#9ca3af'
                                    },
                                    beginAtZero: true
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    this.charts.set('productionChart', chart);
                } catch (error) {
                    console.error('Error creating production chart:', error);
                }
            }

            createParametersChart() {
                const canvas = document.getElementById('parametersChart');
                if (!canvas) {
                    console.error('Parameters chart canvas not found');
                    return;
                }

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                try {
                    const chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Voltage', 'Current', 'Pressure', 'Flow Rate', 'Purity', 'Temp'],
                            datasets: [
                                {
                                    label: 'Current Values',
                                    data: [],
                                    backgroundColor: [
                                        this.hexToRgba('#3b82f6', 0.8),
                                        this.hexToRgba('#10b981', 0.8),
                                        this.hexToRgba('#f59e0b', 0.8),
                                        this.hexToRgba('#ef4444', 0.8),
                                        this.hexToRgba('#8b5cf6', 0.8),
                                        this.hexToRgba('#06b6d4', 0.8)
                                    ],
                                    borderColor: [
                                        '#3b82f6', '#10b981', '#f59e0b', 
                                        '#ef4444', '#8b5cf6', '#06b6d4'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#e5e7eb',
                                        font: { size: 12 }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'System Parameters - Awaiting Simulation Data',
                                    color: '#f9fafb',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' }
                                },
                                y: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' },
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    this.charts.set('parametersChart', chart);
                } catch (error) {
                    console.error('Error creating parameters chart:', error);
                }
            }

            initComparisonCharts() {
                const comparisonCharts = [
                    { method: 'createSafetyChart', id: 'safetyChart' },
                    { method: 'createEconomicChart', id: 'economicChart' },
                    { method: 'createPerformanceChart', id: 'performanceChart' },
                    { method: 'createTrendsChart', id: 'trendsChart' },
                    { method: 'createSimulinkChart', id: 'simulinkChart' },
                    { method: 'createMultiMpcComparisonChart', id: 'multiMpcComparisonChart' },
                    { method: 'createMpcPerformanceRadar', id: 'mpcPerformanceRadar' },
                    { method: 'createResponseTimeChart', id: 'responseTimeChart' }
                ];

                comparisonCharts.forEach(chartConfig => {
                    const canvas = document.getElementById(chartConfig.id);
                    if (canvas) {
                        this[chartConfig.method]();
                    } else {
                        console.log(`Canvas ${chartConfig.id} not found yet (might be in hidden tab)`);
                    }
                });
            }

            createSafetyChart() {
                const canvas = document.getElementById('safetyChart');
                if (!canvas) {
                    console.log('Safety chart canvas not available yet');
                    return;
                }

                const style = window.getComputedStyle(canvas);
                if (style.display === 'none' || canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
                    console.log('Safety chart canvas is hidden, will initialize when tab is activated');
                    return;
                }

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                try {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.generateTimeLabels(8),
                            datasets: [
                                {
                                    label: 'Temperature Margin',
                                    data: [],
                                    borderColor: '#ef4444',
                                    backgroundColor: this.hexToRgba('#ef4444', 0.1),
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Pressure Margin',
                                    data: [],
                                    borderColor: '#f59e0b',
                                    backgroundColor: this.hexToRgba('#f59e0b', 0.1),
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: { color: '#e5e7eb' }
                                },
                                title: {
                                    display: true,
                                    text: 'Safety Margins - Awaiting Simulation Data',
                                    color: '#f9fafb'
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' }
                                },
                                y: {
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9ca3af' },
                                    title: {
                                        display: true,
                                        text: 'Safety Margin (%)',
                                        color: '#9ca3af'
                                    },
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });

                    this.charts.set('safetyChart', chart);
                    console.log('Safety chart initialized successfully');
                } catch (error) {
                    console.error('Error creating safety chart:', error);
                }
            }

            createEconomicChart() {
                const canvas = document.getElementById('economicChart');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Energy Cost', 'H₂ Cost', 'Op Cost', 'Revenue', 'Profit'],
                        datasets: [{
                            label: 'Economic Metrics',
                            data: [],
                            backgroundColor: [
                                this.hexToRgba('#ef4444', 0.8),
                                this.hexToRgba('#f59e0b', 0.8),
                                this.hexToRgba('#8b5cf6', 0.8),
                                this.hexToRgba('#10b981', 0.8),
                                this.hexToRgba('#3b82f6', 0.8)
                            ],
                            borderColor: [
                                '#ef4444', '#f59e0b', '#8b5cf6', '#10b981', '#3b82f6'
                            ],
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Economic Analysis - Awaiting Simulation Data',
                                color: '#f9fafb'
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' },
                                title: {
                                    display: true,
                                    text: 'Cost/Revenue ($/hr)',
                                    color: '#9ca3af'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });

                this.charts.set('economicChart', chart);
            }

            createPerformanceChart() {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) {
                    console.error('Performance chart canvas not found');
                    return;
                }

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                try {
                    const chart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: [
                                'Tracking Accuracy', 
                                'Response Speed', 
                                'Energy Efficiency',
                                'Constraint Handling', 
                                'Robustness',
                                'Computational Speed'
                            ],
                            datasets: [
                                {
                                    label: 'HE-NMPC (Hybrid Evolutionary)',
                                    data: [],
                                    borderColor: '#3b82f6',
                                    backgroundColor: this.hexToRgba('#3b82f6', 0.3),
                                    borderWidth: 3,
                                    pointBackgroundColor: '#3b82f6',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4
                                },
                                {
                                    label: 'Traditional MPC',
                                    data: [],
                                    borderColor: '#ef4444',
                                    backgroundColor: this.hexToRgba('#ef4444', 0.3),
                                    borderWidth: 3,
                                    pointBackgroundColor: '#ef4444',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#e5e7eb',
                                        font: { size: 12 }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'MPC Performance Comparison - Awaiting Simulation Data',
                                    color: '#f9fafb',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            scales: {
                                r: {
                                    angleLines: { color: '#374151' },
                                    grid: { color: '#374151' },
                                    pointLabels: { 
                                        color: '#9ca3af',
                                        font: { size: 11 }
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        backdropColor: 'transparent',
                                        stepSize: 20
                                    },
                                    beginAtZero: true,
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            },
                            elements: {
                                line: {
                                    borderWidth: 3
                                }
                            }
                        }
                    });

                    this.charts.set('performanceChart', chart);
                } catch (error) {
                    console.error('Error creating performance chart:', error);
                }
            }

            createTrendsChart() {
                const canvas = document.getElementById('trendsChart');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.generateTimeLabels(10),
                        datasets: [
                            {
                                label: 'HE-NMPC Efficiency',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: this.hexToRgba('#3b82f6', 0.1),
                                borderWidth: 3,
                                tension: 0.4,
                                fill: false
                            },
                            {
                                label: 'Traditional MPC Efficiency',
                                data: [],
                                borderColor: '#ef4444',
                                backgroundColor: this.hexToRgba('#ef4444', 0.1),
                                borderWidth: 3,
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb' }
                            },
                            title: {
                                display: true,
                                text: 'Efficiency Trends - Awaiting Simulation Data',
                                color: '#f9fafb'
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' },
                                title: {
                                    display: true,
                                    text: 'Efficiency (%)',
                                    color: '#9ca3af'
                                },
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });

                this.charts.set('trendsChart', chart);
            }

            createSimulinkChart() {
                const canvas = document.getElementById('simulinkChart');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.generateTimeLabels(10),
                        datasets: [
                            {
                                label: 'Simulink O₂ Production',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: this.hexToRgba('#3b82f6', 0.1),
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Real System O₂ Production',
                                data: [],
                                borderColor: '#10b981',
                                backgroundColor: this.hexToRgba('#10b981', 0.1),
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb' }
                            },
                            title: {
                                display: true,
                                text: 'Simulink vs Real System - Awaiting Simulation Data',
                                color: '#f9fafb'
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' },
                                title: {
                                    display: true,
                                    text: 'Production Rate (L/min)',
                                    color: '#9ca3af'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });

                this.charts.set('simulinkChart', chart);
            }

            createMultiMpcComparisonChart() {
                const canvas = document.getElementById('multiMpcComparisonChart');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['HE-NMPC', 'Traditional', 'Stochastic', 'Mixed Integer'],
                        datasets: [
                            {
                                label: 'Efficiency (%)',
                                data: [84.5, 76.2, 79.8, 81.3],
                                backgroundColor: '#3b82f6',
                                borderColor: '#2563eb',
                                borderWidth: 2
                            },
                            {
                                label: 'Response Time (s)',
                                data: [0.8, 1.5, 1.2, 2.1],
                                backgroundColor: '#ef4444',
                                borderColor: '#dc2626',
                                borderWidth: 2
                            },
                            {
                                label: 'Stability (%)',
                                data: [98, 85, 92, 88],
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Multi-MPC Performance Comparison',
                                color: '#f9fafb',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                this.charts.set('multiMpcComparisonChart', chart);
            }

            createMpcPerformanceRadar() {
                const canvas = document.getElementById('mpcPerformanceRadar');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Efficiency', 'Speed', 'Robustness', 'Accuracy', 'Stability', 'Adaptability'],
                        datasets: [
                            {
                                label: 'HE-NMPC',
                                data: [95, 90, 92, 88, 98, 94],
                                borderColor: '#3b82f6',
                                backgroundColor: this.hexToRgba('#3b82f6', 0.2),
                                borderWidth: 3
                            },
                            {
                                label: 'Traditional MPC',
                                data: [76, 65, 70, 72, 85, 68],
                                borderColor: '#ef4444',
                                backgroundColor: this.hexToRgba('#ef4444', 0.2),
                                borderWidth: 3
                            },
                            {
                                label: 'Stochastic MPC',
                                data: [82, 78, 85, 80, 92, 79],
                                borderColor: '#f59e0b',
                                backgroundColor: this.hexToRgba('#f59e0b', 0.2),
                                borderWidth: 3
                            },
                            {
                                label: 'Mixed Integer MPC',
                                data: [85, 60, 88, 85, 88, 82],
                                borderColor: '#8b5cf6',
                                backgroundColor: this.hexToRgba('#8b5cf6', 0.2),
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'MPC Capability Radar Comparison',
                                color: '#f9fafb',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            r: {
                                angleLines: { color: '#374151' },
                                grid: { color: '#374151' },
                                pointLabels: { color: '#9ca3af' },
                                ticks: { 
                                    color: '#9ca3af',
                                    backdropColor: 'transparent'
                                },
                                beginAtZero: true,
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });

                this.charts.set('mpcPerformanceRadar', chart);
            }

            createResponseTimeChart() {
                const canvas = document.getElementById('responseTimeChart');
                if (!canvas) return;

                const existingChart = Chart.getChart(canvas);
                if (existingChart) existingChart.destroy();

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.generateTimeLabels(8),
                        datasets: [
                            {
                                label: 'HE-NMPC Response',
                                data: [0.8, 0.82, 0.79, 0.81, 0.8, 0.78, 0.79, 0.8],
                                borderColor: '#3b82f6',
                                backgroundColor: this.hexToRgba('#3b82f6', 0.1),
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Traditional MPC Response',
                                data: [1.5, 1.6, 1.55, 1.52, 1.48, 1.53, 1.51, 1.49],
                                borderColor: '#ef4444',
                                backgroundColor: this.hexToRgba('#ef4444', 0.1),
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Stochastic MPC Response',
                                data: [1.2, 1.18, 1.22, 1.19, 1.21, 1.2, 1.17, 1.19],
                                borderColor: '#f59e0b',
                                backgroundColor: this.hexToRgba('#f59e0b', 0.1),
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'MPC Response Time Trends (seconds)',
                                color: '#f9fafb',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9ca3af' },
                                title: {
                                    display: true,
                                    text: 'Response Time (s)',
                                    color: '#9ca3af'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });

                this.charts.set('responseTimeChart', chart);
            }

            // Add method to initialize charts when tab becomes visible
            initializeTabCharts(tabName) {
                console.log(`Initializing charts for tab: ${tabName}`);
                
                switch(tabName) {
                    case 'safety':
                        if (!this.charts.has('safetyChart')) {
                            this.createSafetyChart();
                        }
                        break;
                    case 'economic':
                        if (!this.charts.has('economicChart')) {
                            this.createEconomicChart();
                        }
                        break;
                    case 'analytics':
                        if (!this.charts.has('performanceChart')) {
                            this.createPerformanceChart();
                        }
                        if (!this.charts.has('trendsChart')) {
                            this.createTrendsChart();
                        }
                        if (!this.charts.has('multiMpcComparisonChart')) {
                            this.createMultiMpcComparisonChart();
                        }
                        if (!this.charts.has('mpcPerformanceRadar')) {
                            this.createMpcPerformanceRadar();
                        }
                        if (!this.charts.has('responseTimeChart')) {
                            this.createResponseTimeChart();
                        }
                        break;
                    case 'simulink':
                        if (!this.charts.has('simulinkChart')) {
                            this.createSimulinkChart();
                        }
                        break;
                }
                
                // Resize charts after tab switch
                setTimeout(() => {
                    this.resizeCharts();
                }, 100);
            }

            resizeCharts() {
                this.charts.forEach((chart, chartId) => {
                    if (chart && typeof chart.resize === 'function') {
                        try {
                            // Only resize if canvas is visible and has dimensions
                            const canvas = chart.canvas;
                            if (canvas && canvas.offsetWidth > 0 && canvas.offsetHeight > 0) {
                                chart.resize();
                            }
                        } catch (error) {
                            console.warn(`Could not resize chart ${chartId}:`, error);
                        }
                    }
                });
            }

            updateCharts(data) {
                if (!data) {
                    console.warn('No data provided to update charts');
                    return;
                }
                
                this.updateMiniCharts(data);
                this.updateMainCharts(data);
                this.updateAnalyticsCharts(data);
            }

            updateMiniCharts(data) {
                const chartsToUpdate = [
                    { id: 'productionMiniChart', value: data.o2Production },
                    { id: 'efficiencyMiniChart', value: data.efficiency },
                    { id: 'safetyMiniChart', value: data.safetyMargin },
                    { id: 'temperatureMiniChart', value: data.stackTemperature }
                ];

                chartsToUpdate.forEach(config => {
                    const chart = this.charts.get(config.id);
                    if (chart && config.value !== undefined && config.value !== null) {
                        this.updateChartData(chart, config.value);
                    }
                });
            }

            updateChartData(chart, newValue) {
                if (chart && chart.data && chart.data.datasets[0]) {
                    const dataset = chart.data.datasets[0];
                    
                    // Add new data point
                    dataset.data.push(newValue);
                    
                    // Maintain fixed history length
                    if (dataset.data.length > 10) {
                        dataset.data.shift();
                    }
                    
                    // Update chart
                    chart.update('none');
                }
            }

            updateMainCharts(data) {
                // Update production chart with real data
                const productionChart = this.charts.get('productionChart');
                if (productionChart && data.o2Production !== undefined && data.h2Production !== undefined) {
                    this.shiftChartData(productionChart, data.o2Production, data.h2Production);
                    
                    // Update chart title to show data is live
                    productionChart.options.plugins.title.text = 'Production Trends (Live Simulation)';
                    productionChart.update('none');
                }

                // Update parameters chart with real data - FIXED METHOD NAME
                const parametersChart = this.charts.get('parametersChart');
                if (parametersChart && data.voltage !== undefined) {
                    this.updateParametersChart(data);
                    
                    // Update chart title to show data is live
                    parametersChart.options.plugins.title.text = 'System Parameters (Live Simulation)';
                    parametersChart.update('none');
                }
            }

            updateAnalyticsCharts(data) {
                // Update safety chart
                const safetyChart = this.charts.get('safetyChart');
                if (safetyChart && data.safetyMargin !== undefined) {
                    this.shiftAnalyticsData(safetyChart, data.temperatureMargin || data.safetyMargin, data.pressureMargin || data.safetyMargin * 0.8);
                    safetyChart.options.plugins.title.text = 'Safety Margins (Live Simulation)';
                    safetyChart.update('none');
                }

                // Update trends chart
                const trendsChart = this.charts.get('trendsChart');
                if (trendsChart && data.efficiency !== undefined) {
                    this.shiftTrendsData(trendsChart, data.efficiency, data.efficiency * 0.85);
                    trendsChart.options.plugins.title.text = 'Efficiency Trends (Live Simulation)';
                    trendsChart.update('none');
                }

                // Update simulink chart
                const simulinkChart = this.charts.get('simulinkChart');
                if (simulinkChart && data.o2Production !== undefined) {
                    this.shiftSimulinkData(simulinkChart, data.o2Production, data.o2Production * 1.1);
                    simulinkChart.options.plugins.title.text = 'Simulink vs Real System (Live Simulation)';
                    simulinkChart.update('none');
                }

                // Update economic chart
                const economicChart = this.charts.get('economicChart');
                if (economicChart && data.powerConsumption !== undefined) {
                    this.updateEconomicChart(economicChart, data);
                    economicChart.options.plugins.title.text = 'Economic Analysis (Live Simulation)';
                    economicChart.update('none');
                }
            }

            shiftChartData(chart, o2Value, h2Value) {
                if (chart.data.datasets[0] && chart.data.datasets[1]) {
                    // Shift O2 data
                    chart.data.datasets[0].data.push(o2Value);
                    if (chart.data.datasets[0].data.length > 12) {
                        chart.data.datasets[0].data.shift();
                    }
                    
                    // Shift H2 data
                    chart.data.datasets[1].data.push(h2Value);
                    if (chart.data.datasets[1].data.length > 12) {
                        chart.data.datasets[1].data.shift();
                    }
                    
                    // Update labels
                    chart.data.labels = this.generateTimeLabels(chart.data.datasets[0].data.length);
                    
                    chart.update('none');
                }
            }

            shiftAnalyticsData(chart, tempMargin, pressureMargin) {
                if (chart.data.datasets[0] && chart.data.datasets[1]) {
                    chart.data.datasets[0].data.push(tempMargin);
                    chart.data.datasets[1].data.push(pressureMargin);
                    
                    if (chart.data.datasets[0].data.length > 8) {
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    
                    chart.data.labels = this.generateTimeLabels(chart.data.datasets[0].data.length);
                    chart.update('none');
                }
            }

            shiftTrendsData(chart, heNmpcEfficiency, traditionalEfficiency) {
                if (chart.data.datasets[0] && chart.data.datasets[1]) {
                    chart.data.datasets[0].data.push(heNmpcEfficiency);
                    chart.data.datasets[1].data.push(traditionalEfficiency);
                    
                    if (chart.data.datasets[0].data.length > 10) {
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    
                    chart.data.labels = this.generateTimeLabels(chart.data.datasets[0].data.length);
                    chart.update('none');
                }
            }

            shiftSimulinkData(chart, simulinkValue, realValue) {
                if (chart.data.datasets[0] && chart.data.datasets[1]) {
                    chart.data.datasets[0].data.push(simulinkValue);
                    chart.data.datasets[1].data.push(realValue);
                    
                    if (chart.data.datasets[0].data.length > 10) {
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    
                    chart.data.labels = this.generateTimeLabels(chart.data.datasets[0].data.length);
                    chart.update('none');
                }
            }

            // FIXED METHOD - This was causing the error
            updateParametersChart(data) {
                const chart = this.charts.get('parametersChart');
                if (chart && chart.data.datasets[0]) {
                    // Update with real parameter data
                    chart.data.datasets[0].data = [
                        data.voltage || 0,
                        data.current || 0,
                        data.pressure || 0,
                        data.flowRate || 0,
                        data.purity || 0,
                        data.stackTemperature || 0
                    ];
                    
                    chart.update('none');
                }
            }

            updateEconomicChart(chart, data) {
                if (chart.data.datasets[0]) {
                    // Calculate economic metrics based on real data
                    const energyCost = (data.powerConsumption || 0) * 0.12; // $0.12/kWh
                    const h2Cost = (data.o2Production || 0) * 0.15; // $0.15/L O2 equivalent
                    const opCost = energyCost + h2Cost + 25; // Fixed costs
                    const revenue = (data.o2Production || 0) * 2.5; // $2.5/L O2
                    const profit = revenue - opCost;
                    
                    chart.data.datasets[0].data = [energyCost, h2Cost, opCost, revenue, profit];
                    chart.update('none');
                }
            }

            updatePerformanceChart(heNmpcData, traditionalMpcData) {
                const performanceChart = this.charts.get('performanceChart');
                if (!performanceChart) return;

                // Only update if we have real MPC comparison data
                if (heNmpcData && traditionalMpcData && 
                    Array.isArray(heNmpcData) && Array.isArray(traditionalMpcData) &&
                    heNmpcData.length === 6 && traditionalMpcData.length === 6) {
                    
                    performanceChart.data.datasets[0].data = heNmpcData;
                    performanceChart.data.datasets[1].data = traditionalMpcData;
                    performanceChart.options.plugins.title.text = 'MPC Performance Comparison (Live Simulation)';
                    performanceChart.update('none');
                    
                    console.log('MPC Performance chart updated with real comparison data');
                } else {
                    console.warn('Invalid MPC comparison data format received');
                }
            }

            updateAllChartsWithSimulationData(simulationData) {
                if (!simulationData) {
                    console.log('No simulation data received');
                    return;
                }

                console.log('Updating all charts with simulation data:', simulationData);

                try {
                    // Update main production charts
                    if (simulationData.o2Production !== undefined) {
                        this.updateProductionData(simulationData);
                    }

                    // Update parameters chart - FIXED: Now calls updateParametersChart (not updateParametersData)
                    if (simulationData.voltage !== undefined) {
                        this.updateParametersChart(simulationData);
                    }

                    // Update mini charts
                    this.updateMiniCharts(simulationData);

                    // Update MPC performance comparison if we have the data
                    if (simulationData.mpcComparison) {
                        this.updatePerformanceChart(
                            simulationData.mpcComparison.heNmpc,
                            simulationData.mpcComparison.traditional
                        );
                    }

                    // Update safety margins
                    if (simulationData.safetyMetrics) {
                        this.updateSafetyData(simulationData.safetyMetrics);
                    }

                    // Update economic data
                    if (simulationData.economicMetrics) {
                        this.updateEconomicData(simulationData.economicMetrics);
                    }
                } catch (error) {
                    console.error('Error updating charts with simulation data:', error);
                }
            }

            updateProductionData(data) {
                const productionChart = this.charts.get('productionChart');
                if (productionChart) {
                    this.shiftChartData(productionChart, data.o2Production, data.h2Production || data.o2Production * 2);
                    productionChart.options.plugins.title.text = 'Production Trends (Live Simulation)';
                    productionChart.update('none');
                }
            }

            updateSafetyData(safetyData) {
                const safetyChart = this.charts.get('safetyChart');
                if (safetyChart) {
                    this.shiftAnalyticsData(
                        safetyChart, 
                        safetyData.temperatureMargin || 0,
                        safetyData.pressureMargin || 0
                    );
                    safetyChart.options.plugins.title.text = 'Safety Margins (Live Simulation)';
                    safetyChart.update('none');
                }

                const trendsChart = this.charts.get('trendsChart');
                if (trendsChart && safetyData.efficiency !== undefined) {
                    this.shiftTrendsData(
                        trendsChart,
                        safetyData.efficiency,
                        safetyData.traditionalEfficiency || safetyData.efficiency * 0.85
                    );
                    trendsChart.options.plugins.title.text = 'Efficiency Trends (Live Simulation)';
                    trendsChart.update('none');
                }
            }

            updateEconomicData(economicData) {
                const economicChart = this.charts.get('economicChart');
                if (economicChart) {
                    economicChart.data.datasets[0].data = [
                        economicData.energyCost || 0,
                        economicData.h2Cost || 0,
                        economicData.operatingCost || 0,
                        economicData.revenue || 0,
                        economicData.profit || 0
                    ];
                    economicChart.options.plugins.title.text = 'Economic Analysis (Live Simulation)';
                    economicChart.update('none');
                }
            }

            generateTimeLabels(count) {
                const now = new Date();
                return Array.from({length: count}, (_, i) => {
                    const time = new Date(now.getTime() - (count - i - 1) * 3600000);
                    return time.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    });
                });
            }

            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            // Method to clear all chart data
            clearAllChartData() {
                this.charts.forEach((chart, chartId) => {
                    if (chart && chart.data) {
                        // Clear all datasets
                        chart.data.datasets.forEach(dataset => {
                            dataset.data = [];
                        });
                        
                        // Reset titles to "awaiting data"
                        if (chart.options.plugins.title) {
                            chart.options.plugins.title.text = chart.options.plugins.title.text.replace('(Live Simulation)', '- Awaiting Simulation Data');
                        }
                        
                        chart.update('none');
                    }
                });
                
                console.log('All chart data cleared - waiting for new simulation data');
            }
        }

        // Initialize chart manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.chartManager = new ChartManager();
            
            // Listen for tab changes to initialize hidden charts
            document.addEventListener('tabChanged', function(event) {
                if (window.chartManager && event.detail && event.detail.tabName) {
                    window.chartManager.initializeTabCharts(event.detail.tabName);
                }
            });
        });
    </script>

    <script>
        // navigation.js
        class NavigationManager {
            constructor() {
                this.currentTab = 'dashboard';
                this.init();
            }

            init() {
                this.setupTabListeners();
                this.switchToTab('dashboard');
                console.log('Navigation Manager Initialized - All Tabs Enabled');
            }

            setupTabListeners() {
                const tabButtons = document.querySelectorAll('.nav-tab');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabName = button.dataset.tab;
                        this.switchToTab(tabName);
                    });
                });
            }

            switchToTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Update current tab
                this.currentTab = tabName;

                // Dispatch event for other components
                document.dispatchEvent(new CustomEvent('tabChanged', {
                    detail: { tabName }
                }));

                console.log(`Switching to tab: ${tabName}`);
            }

            updateSimulinkStatus(status) {
                const statusElement = document.getElementById('simulinkStatus');
                if (statusElement) {
                    statusElement.textContent = status;
                    statusElement.className = `status-badge ${
                        status === 'connected' ? 'success' : 
                        status === 'running' ? 'info' : 'warning'
                    }`;
                }
            }
        }

        // Initialize navigation when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.navigationManager = new NavigationManager();
        });
    </script>

    <script>
        // neural-mpc.js
        class NeuralMPCManager {
            constructor() {
                this.isInitialized = false;
                this.performanceMetrics = {};
                this.init();
            }

            init() {
                console.log('Neural MPC Manager Initializing...');
                this.setupEventListeners();
                this.isInitialized = true;
                console.log('Neural MPC Manager Ready');
            }

            setupEventListeners() {
                // MPC-specific event listeners can be added here
            }

            updatePerformanceMetrics(metrics) {
                this.performanceMetrics = { ...this.performanceMetrics, ...metrics };
                this.updateMPCComparisonUI();
            }

            updateMPCComparisonUI() {
                // Update MPC comparison cards with real data
                const metrics = this.performanceMetrics;
                
                if (metrics.heNmpc) {
                    document.getElementById('heNmpcEfficiency').textContent = `${metrics.heNmpc.efficiency}%`;
                    document.getElementById('heNmpcResponse').textContent = `${metrics.heNmpc.responseTime}s`;
                    document.getElementById('heNmpcStability').textContent = `${metrics.heNmpc.stability}%`;
                }

                if (metrics.traditional) {
                    document.getElementById('traditionalEfficiency').textContent = `${metrics.traditional.efficiency}%`;
                    document.getElementById('traditionalResponse').textContent = `${metrics.traditional.responseTime}s`;
                    document.getElementById('traditionalStability').textContent = `${metrics.traditional.stability}%`;
                }

                if (metrics.stochastic) {
                    document.getElementById('stochasticEfficiency').textContent = `${metrics.stochastic.efficiency}%`;
                    document.getElementById('stochasticResponse').textContent = `${metrics.stochastic.responseTime}s`;
                    document.getElementById('stochasticStability').textContent = `${metrics.stochastic.stability}%`;
                }

                if (metrics.mixedInteger) {
                    document.getElementById('mixedIntegerEfficiency').textContent = `${metrics.mixedInteger.efficiency}%`;
                    document.getElementById('mixedIntegerResponse').textContent = `${metrics.mixedInteger.responseTime}s`;
                    document.getElementById('mixedIntegerStability').textContent = `${metrics.mixedInteger.stability}%`;
                }
            }

            // Method to simulate MPC performance data
            simulateMPCData() {
                return {
                    heNmpc: {
                        efficiency: 84.5 + (Math.random() * 4 - 2),
                        responseTime: 0.8 + (Math.random() * 0.4 - 0.2),
                        stability: 98 + (Math.random() * 2 - 1)
                    },
                    traditional: {
                        efficiency: 76.2 + (Math.random() * 4 - 2),
                        responseTime: 1.5 + (Math.random() * 0.4 - 0.2),
                        stability: 85 + (Math.random() * 3 - 1.5)
                    },
                    stochastic: {
                        efficiency: 79.8 + (Math.random() * 3 - 1.5),
                        responseTime: 1.2 + (Math.random() * 0.3 - 0.15),
                        stability: 92 + (Math.random() * 2 - 1)
                    },
                    mixedInteger: {
                        efficiency: 81.3 + (Math.random() * 3 - 1.5),
                        responseTime: 2.1 + (Math.random() * 0.5 - 0.25),
                        stability: 88 + (Math.random() * 3 - 1.5)
                    }
                };
            }
        }

        // Initialize Neural MPC Manager
        document.addEventListener('DOMContentLoaded', function() {
            window.neuralMpcManager = new NeuralMPCManager();
        });
    </script>

    <script>
        // simulink-bridge.js
        class SimulinkBridge {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectInterval = 3000;
                this.fallbackInterval = null;
                this.init();
            }

            init() {
                console.log('Simulink Bridge Initializing for PEM Electrolyzer...');
                this.setupWebSocket();
                this.setupFallbackSimulation();
            }

            setupWebSocket() {
                try {
                    this.socket = new WebSocket('ws://localhost:8080');
                    
                    this.socket.onopen = () => {
                        console.log('✅ Connected to MATLAB/Simulink');
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        if (this.fallbackInterval) {
                            clearInterval(this.fallbackInterval);
                            this.fallbackInterval = null;
                        }
                        if (this.onConnectionStateChange) {
                            this.onConnectionStateChange(true);
                        }
                    };

                    this.socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.processSimulationData(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    this.socket.onclose = () => {
                        console.log('❌ Disconnected from MATLAB/Simulink');
                        this.isConnected = false;
                        this.handleDisconnection();
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                    };

                } catch (error) {
                    console.error('WebSocket setup failed:', error);
                    this.fallbackToMQTT();
                }
            }

            handleDisconnection() {
                if (this.onConnectionStateChange) {
                    this.onConnectionStateChange(false);
                }
                
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Attempting reconnect ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);
                    setTimeout(() => this.setupWebSocket(), this.reconnectInterval);
                } else {
                    console.log('Max reconnection attempts reached, staying in fallback mode');
                    this.fallbackToMQTT();
                }
            }

            fallbackToMQTT() {
                console.log('Falling back to MQTT for data simulation');
                this.startFallbackSimulation();
            }

            setupFallbackSimulation() {
                // Start fallback simulation if WebSocket doesn't connect within 2 seconds
                setTimeout(() => {
                    if (!this.isConnected && !this.fallbackInterval) {
                        this.fallbackToMQTT();
                    }
                }, 2000);
            }

            startFallbackSimulation() {
                console.log('Starting fallback simulation data stream');
                
                this.fallbackInterval = setInterval(() => {
                    const simulatedData = this.generateSimulationData();
                    this.processSimulationData(simulatedData);
                }, 1000); // Emit data every second
            }

            generateSimulationData() {
                // Generate realistic PEM electrolyzer simulation data
                const baseO2Production = 30 + Math.random() * 20;
                const noise = (Math.random() - 0.5) * 8;
                
                return {
                    o2_production: Math.max(10, baseO2Production + noise),
                    efficiency: 75 + Math.random() * 10,
                    current_temp: 25 + Math.random() * 15,
                    safety_margin: 80 + Math.random() * 20,
                    stack_efficiency: 75,
                    voltage: 2.1,
                    current: 150,
                    pressure: 30 + Math.random() * 10,
                    flow_rate: 45 + Math.random() * 15,
                    purity: 99.5 + Math.random() * 0.5,
                    power_consumption: 3.5 + Math.random() * 1.5,
                    timestamp: new Date().toISOString()
                };
            }

            processSimulationData(rawData) {
                console.log('Processing electrolyzer data from MATLAB:', rawData);

                // Transform MATLAB data to our application format
                const processedData = {
                    o2Production: rawData.o2_production,
                    h2Production: rawData.o2_production * 2, // H2 is typically 2x O2 in PEM
                    efficiency: rawData.efficiency,
                    stackTemperature: rawData.current_temp,
                    safetyMargin: rawData.safety_margin,
                    voltage: rawData.voltage,
                    current: rawData.current,
                    pressure: rawData.pressure,
                    flowRate: rawData.flow_rate,
                    purity: rawData.purity,
                    powerConsumption: rawData.power_consumption,
                    timestamp: rawData.timestamp || new Date().toISOString()
                };

                // Add some simulated MPC comparison data
                processedData.mpcComparison = {
                    heNmpc: [95, 90, 92, 88, 98, 94].map(v => v + (Math.random() * 4 - 2)),
                    traditional: [76, 65, 70, 72, 85, 68].map(v => v + (Math.random() * 6 - 3))
                };

                // Call the simulation data callback
                if (this.onSimulationData) {
                    this.onSimulationData(processedData);
                }
            }

            sendCommand(command) {
                if (this.isConnected && this.socket) {
                    this.socket.send(JSON.stringify({ command }));
                } else {
                    console.log('WebSocket not connected, using fallback simulation');
                }
            }

            startSimulation() {
                this.sendCommand('start_simulation');
            }

            stopSimulation() {
                if (this.fallbackInterval) {
                    clearInterval(this.fallbackInterval);
                    this.fallbackInterval = null;
                }
                this.sendCommand('stop_simulation');
            }

            // Method to inject test data for development
            injectTestData() {
                const testData = {
                    o2_production: 42.5,
                    efficiency: 82.3,
                    current_temp: 34.2,
                    safety_margin: 91.7,
                    stack_efficiency: 75,
                    voltage: 2.1,
                    current: 150,
                    pressure: 32.8,
                    flow_rate: 48.2,
                    purity: 99.7,
                    power_consumption: 4.1,
                    timestamp: new Date().toISOString()
                };
                this.processSimulationData(testData);
            }
        }

        // Initialize Simulink Bridge
        document.addEventListener('DOMContentLoaded', function() {
            window.simulinkBridge = new SimulinkBridge();
        });
    </script>

    <script>
        // app.js - Fixed Initialization
        class ElectrolyzerApp {
            constructor() {
                this.mqttClient = null;
                this.currentData = null;
                this.simulationData = null;
                this.isConnected = false;
                this.chartManager = null;
                this.simulinkBridge = null;
                this.dataPointsReceived = 0;
                
                this.init();
            }

            init() {
                console.log('HE-NMPC Electrolyzer Controller Initializing...');
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.initializeApp());
                } else {
                    this.initializeApp();
                }
            }

            initializeApp() {
                console.log('DOM fully loaded, initializing components...');
                
                // Initialize components in correct order
                this.initChartManager();
                this.initSimulinkBridge();
                this.initEventListeners();
                this.updateSystemStatus();
                
                this.connectToSimulation().catch(error => {
                    console.error('Simulation connection failed:', error);
                    this.showNotification('Starting fallback simulation mode...', 'warning');
                });
            }

            initChartManager() {
                try {
                    this.chartManager = new ChartManager();
                    console.log('Chart Manager Initialized');
                } catch (error) {
                    console.error('Error initializing chart manager:', error);
                }
            }

            initSimulinkBridge() {
                try {
                    this.simulinkBridge = new SimulinkBridge();
                    this.setupSimulinkCallbacks();
                    console.log('Simulink bridge initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize Simulink bridge:', error);
                    this.showNotification('Using fallback simulation mode', 'info');
                }
            }

            initEventListeners() {
                // Window resize handling
                window.addEventListener('resize', () => {
                    if (this.chartManager) {
                        setTimeout(() => this.chartManager.resizeCharts(), 100);
                    }
                });

                // System control buttons
                const controlButtons = document.querySelectorAll('.control-btn');
                controlButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.handleControlAction(e.target.dataset.action);
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'r':
                                e.preventDefault();
                                this.refreshData();
                                break;
                            case 'd':
                                e.preventDefault();
                                this.toggleDataView();
                                break;
                        }
                    }
                });

                console.log('Event listeners initialized');
            }

            setupSimulinkCallbacks() {
                if (!this.simulinkBridge) return;

                // Real simulation data callback
                this.simulinkBridge.onSimulationData = (data) => {
                    this.handleSimulationData(data);
                };

                // MPC comparison data callback
                this.simulinkBridge.onMPCComparison = (comparisonData) => {
                    this.handleMPCComparisonData(comparisonData);
                };

                // Simulation status callback
                this.simulinkBridge.onSimulationStatus = (status) => {
                    this.updateSimulationStatus(status);
                };

                // Connection state callback
                this.simulinkBridge.onConnectionStateChange = (connected) => {
                    this.updateConnectionStatus('simulink', connected);
                };
            }

            async connectToSimulation() {
                console.log('Connecting to MATLAB/Simulink simulation...');
                
                if (this.simulinkBridge) {
                    try {
                        await this.simulinkBridge.connect();
                        this.isConnected = true;
                        this.updateConnectionStatus('simulink', true);
                        this.showNotification('Connected to MATLAB simulation', 'success');
                        
                        // Start simulation automatically
                        setTimeout(() => {
                            this.simulinkBridge.startSimulation();
                        }, 1000);
                        
                    } catch (error) {
                        console.warn('Simulink connection failed, using fallback:', error);
                        this.isConnected = false;
                    }
                } else {
                    throw new Error('Simulink bridge not available');
                }
            }

            handleSimulationData(simulationData) {
                console.log('📊 Received simulation data:', simulationData);
                
                this.dataPointsReceived++;
                this.simulationData = simulationData;
                this.currentData = simulationData;
                
                // Update charts with real simulation data
                if (this.chartManager) {
                    this.chartManager.updateAllChartsWithSimulationData(this.currentData);
                }
                
                // Update UI
                this.updateDashboard(this.currentData);
                this.updateLiveDataFeed(this.currentData);
                this.updateSystemMetrics(this.currentData);
                
                // Update data points counter
                this.updateDataPointsCount();
            }

            handleMPCComparisonData(comparisonData) {
                console.log('📈 Received MPC comparison data:', comparisonData);
                
                // Update performance chart with real MPC comparison data
                if (this.chartManager) {
                    this.chartManager.updatePerformanceChart(
                        comparisonData.heNmpc,
                        comparisonData.traditional
                    );
                }
                
                // Update analytics metrics
                this.updateAnalyticsMetrics(comparisonData);
            }

            updateDashboard(data) {
                // Update main metrics with real data
                this.updateMetricValue('productionValue', data.o2Production, '%');
                this.updateMetricValue('efficiencyValue', data.efficiency, '%');
                this.updateMetricValue('safetyValue', data.safetyMargin, '%');
                this.updateMetricValue('temperatureValue', data.stackTemperature, '°C');
            }

            updateMetricValue(elementId, value, suffix = '') {
                const element = document.getElementById(elementId);
                if (element && value !== undefined && value !== null) {
                    element.textContent = value.toFixed(1) + suffix;
                    
                    // Add animation effect for live data
                    element.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 200);
                }
            }

            updateLiveDataFeed(data) {
                // Update live data display with real values
                this.updateLiveValue('liveO2Production', data.o2Production, '%');
                this.updateLiveValue('liveEfficiency', data.efficiency, '%');
                this.updateLiveValue('liveTemperature', data.stackTemperature, '°C');
                this.updateLiveValue('livePower', data.powerConsumption, 'kW');

                // Update Simulink tab real-time data
                this.updateLiveValue('simO2Production', data.o2Production, ' L/min');
                this.updateLiveValue('simStackTemp', data.stackTemperature, '°C');
                this.updateLiveValue('simEfficiency', data.efficiency, '%');
                this.updateLiveValue('simPower', data.powerConsumption, 'kW');
            }

            updateLiveValue(elementId, value, suffix = '') {
                const element = document.getElementById(elementId);
                if (element && value !== undefined && value !== null) {
                    const formattedValue = typeof value === 'number' ? value.toFixed(1) : value;
                    element.textContent = formattedValue + suffix;
                }
            }

            updateSystemMetrics(data) {
                // Update system status with real data
                this.updateStatusBadge('controllerMode', 'HE-NMPC', 'success');
                this.updateStatusBadge('operationMode', this.isConnected ? 'LIVE' : 'SIMULATION', 'info');
                this.updateStatusBadge('safetyViolations', '0', 'success');
                this.updateStatusBadge('simulinkStatus', this.isConnected ? 'Connected' : 'Fallback', 
                                    this.isConnected ? 'success' : 'warning');
            }

            updateStatusBadge(elementId, text, type) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                    element.className = `status-badge ${type}`;
                }
            }

            updateAnalyticsMetrics(comparisonData) {
                // Update real MPC performance metrics in analytics tab
                const metricsContainer = document.querySelector('.metrics-comparison');
                if (metricsContainer && comparisonData.metrics) {
                    const metrics = comparisonData.metrics;
                    
                    // Update settling time
                    this.updateComparisonMetric(metricsContainer, 1, metrics.settlingTime, 's');
                    
                    // Update overshoot
                    this.updateComparisonMetric(metricsContainer, 2, metrics.overshoot, '%');
                    
                    // Update efficiency
                    this.updateComparisonMetric(metricsContainer, 3, metrics.efficiency, '%');
                    
                    // Update constraint violations
                    this.updateComparisonMetric(metricsContainer, 4, metrics.constraintViolations, '%');
                }
            }

            updateComparisonMetric(container, index, data, unit) {
                const element = container.querySelector(`.metric-comparison-item:nth-child(${index}) .metric-value`);
                if (element && data) {
                    element.textContent = `${data.heNmpc}${unit} / ${data.traditional}${unit}`;
                }
            }

            updateDataPointsCount() {
                const countElement = document.getElementById('dataPointsCount');
                if (countElement) {
                    countElement.textContent = this.dataPointsReceived;
                }
            }

            updateSimulationStatus(status) {
                if (window.navigationManager) {
                    window.navigationManager.updateSimulinkStatus(status.status || 'running');
                }
                
                // Update simulation time
                if (status.simulationTime !== undefined) {
                    const simTimeElement = document.getElementById('simTime');
                    if (simTimeElement) {
                        simTimeElement.textContent = `${status.simulationTime} s`;
                    }
                }
                
                // Update data rate
                if (status.dataRate !== undefined) {
                    const dataRateElement = document.getElementById('dataRate');
                    if (dataRateElement) {
                        dataRateElement.textContent = `${status.dataRate.toFixed(1)} Hz`;
                    }
                }

                // Update last update time
                const lastUpdateElement = document.getElementById('simulinkLastUpdate');
                if (lastUpdateElement) {
                    const now = new Date();
                    lastUpdateElement.textContent = now.toLocaleTimeString('en-US', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
            }

            updateConnectionStatus(component, connected) {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('connectionText');
                
                if (statusElement && textElement) {
                    if (connected) {
                        statusElement.className = 'status-dot connected';
                        textElement.textContent = 'Connected to MATLAB';
                    } else {
                        statusElement.className = 'status-dot disconnected';
                        textElement.textContent = 'Fallback Mode';
                    }
                }
            }

            updateSystemStatus() {
                const systemStatusElement = document.getElementById('systemStatus');
                if (systemStatusElement) {
                    systemStatusElement.textContent = this.isConnected ? 
                        'System Live - Receiving MATLAB Data' : 'System Running - Simulation Mode';
                }
            }

            handleControlAction(action) {
                console.log('Control action triggered:', action);
                
                switch(action) {
                    case 'start':
                        this.sendControlCommand('start');
                        this.showNotification('Sending START command to system...', 'info');
                        break;
                    case 'stop':
                        this.sendControlCommand('stop');
                        this.showNotification('Sending STOP command to system...', 'warning');
                        break;
                    case 'reset':
                        this.sendControlCommand('reset');
                        this.showNotification('Sending RESET command to system...', 'info');
                        break;
                    case 'emergency':
                        this.sendControlCommand('emergency_stop');
                        this.showNotification('EMERGENCY STOP ACTIVATED!', 'error');
                        break;
                }
            }

            sendControlCommand(command) {
                // Send command to real system via MQTT or Simulink
                if (this.simulinkBridge) {
                    try {
                        this.simulinkBridge.sendCommand(command);
                    } catch (error) {
                        console.error('Failed to send command:', error);
                    }
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-message">${message}</span>
                        <button class="notification-close">&times;</button>
                    </div>
                `;
                
                // Add to notification container
                let container = document.getElementById('notification-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'notification-container';
                    container.className = 'notification-container';
                    document.body.appendChild(container);
                }
                
                container.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
                
                // Close button handler
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });
            }

            refreshData() {
                console.log('Manual data refresh requested');
                this.showNotification('Refreshing data from system...', 'info');
                
                // Request latest data from system
                if (this.simulinkBridge) {
                    this.simulinkBridge.sendCommand('refresh_data');
                }
            }

            toggleDataView() {
                // Toggle between different data views
                console.log('Data view toggled');
                this.showNotification('Data view changed', 'info');
            }

            // Method to manually trigger test data
            injectTestData() {
                if (this.simulinkBridge && typeof this.simulinkBridge.injectTestData === 'function') {
                    this.simulinkBridge.injectTestData();
                    this.showNotification('Test data injected for chart verification', 'info');
                }
            }

            // Public method to get current system state
            getSystemState() {
                return {
                    connected: this.isConnected,
                    currentData: this.currentData,
                    dataPointsReceived: this.dataPointsReceived,
                    lastUpdate: this.currentData ? this.currentData.timestamp : null
                };
            }

            // Cleanup method
            destroy() {
                if (this.simulinkBridge) {
                    this.simulinkBridge.stopSimulation();
                }
                console.log('Electrolyzer app cleaned up');
            }
        }

        // Initialize application when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.electrolyzerApp = new ElectrolyzerApp();
            
            // Add global method for testing
            window.injectTestData = function() {
                if (window.electrolyzerApp) {
                    window.electrolyzerApp.injectTestData();
                }
            };
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (window.electrolyzerApp) {
                window.electrolyzerApp.destroy();
            }
        });
    </script>
</body>
</html>
